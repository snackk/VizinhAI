<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <title>VizinhAI - Gestão de Condomínio</title>

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="VizinhAI">
  <meta name="theme-color" content="#2563eb">
  
  <link rel="apple-touch-icon" href="https://via.placeholder.com/192/2563eb/ffffff?text=V">

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    body {
      overscroll-behavior-y: none;
      -webkit-tap-highlight-color: transparent;
    }
    .safe-pt { padding-top: env(safe-area-inset-top); }
    .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    .safe-pl { padding-left: env(safe-area-inset-left); }
    .safe-pr { padding-right: env(safe-area-inset-right); }
    .mobile-header {
      padding-top: env(safe-area-inset-top);
      box-sizing: content-box;
    }
  </style>

  <script>
    // A configuração será injetada aqui pelo GitHub Actions
    window.__firebase_config = '__FIREBASE_CONFIG_PLACEHOLDER__';
    window.__app_id = "vizinhai-app";
  </script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
    import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
    import { 
      Home, Receipt, PieChart, Users, LogOut, Menu, X, 
      AlertCircle, CheckCircle, Plus, FileText, Wallet, 
      TrendingUp, Clock, ShieldAlert, FolderOpen, UploadCloud, 
      Download, Settings, Save, Lock, User, Edit2, Trash2,
      ChevronDown, ChevronUp, Calendar
    } from 'https://esm.sh/lucide-react@0.292.0';

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
    import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

    let firebaseConfig = {};
    try {
      // Evita erro se o placeholder ainda não tiver sido substituído
      if (window.__firebase_config && window.__firebase_config !== '__FIREBASE_CONFIG_PLACEHOLDER__') {
        firebaseConfig = typeof window.__firebase_config === 'string' 
          ? JSON.parse(window.__firebase_config) 
          : window.__firebase_config;
      }
    } catch (e) {
      console.error("Erro ao fazer parse da configuração do Firebase", e);
    }

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const appId = window.__app_id || 'default-app-id';

    const translations = {
      pt: {
        dashboard: "Dashboard",
        condo: "Condomínio",
        documents: "Documentos",
        expenses: "Despesas",
        budgets: "Orçamentos",
        currentAccount: "Conta Corrente",
        fractions: "Frações",
        settings: "Definições",
        summary: "Resumo",
        logout: "Sair da Conta",
        save: "Guardar Alterações",
        saving: "A guardar...",
        profileSaved: "Perfil guardado!",
        errorSaving: "Erro ao guardar.",
        nameLabel: "O seu nome",
        languageLabel: "Língua Preferencial",
        globalVision: "Visão global do condomínio",
        collectedFund: "Fundo Recebido",
        overdueQuotas: "Quotas em Atraso",
        pendingExpenses: "Despesas Pendentes",
        budgetedOf: "De {amount} € orçamentados",
        toReceive: "Valor por receber",
        waitingApproval: "A aguardar aprovação",
        hello: "Olá, {name}",
        unitSummary: "Resumo da sua fração ({unit})",
        amountToPay: "Valor a Pagar",
        regularSituation: "Situação Regular",
        overdueMonths: "Meses em atraso",
        months: {
          0: "Janeiro", 1: "Fevereiro", 2: "Março", 3: "Abril", 4: "Maio", 5: "Junho",
          6: "Julho", 7: "Agosto", 8: "Setembro", 9: "Outubro", 10: "Novembro", 11: "Dezembro"
        },
        phoneLabel: "Número de Telefone",
        phonePlaceholder: "+351 912 345 678",
        promoteAdmin: "Promover a Administrador",
        promoteConfirm: "Tem a certeza que deseja promover {name} a Administrador? Você deixará de ser administrador e a sua sessão será terminada.",
        currentAdmin: "Administrador em Funções",
        adminName: "Nome",
        adminEmail: "E-mail",
        adminPhone: "Telefone"
      },
      en: {
        dashboard: "Dashboard",
        condo: "Condo",
        documents: "Documents",
        expenses: "Expenses",
        budgets: "Budgets",
        currentAccount: "Current Account",
        fractions: "Units",
        settings: "Settings",
        summary: "Summary",
        logout: "Logout",
        save: "Save Changes",
        saving: "Saving...",
        profileSaved: "Profile saved!",
        errorSaving: "Error saving.",
        nameLabel: "Your name",
        languageLabel: "Preferred Language",
        globalVision: "Global condo overview",
        collectedFund: "Collected Fund",
        overdueQuotas: "Overdue Quotas",
        pendingExpenses: "Pending Expenses",
        budgetedOf: "From {amount} € budgeted",
        toReceive: "Amount to receive",
        waitingApproval: "Waiting for approval",
        hello: "Hello, {name}",
        unitSummary: "Unit summary ({unit})",
        amountToPay: "Amount to Pay",
        regularSituation: "Regular Situation",
        overdueMonths: "Overdue months",
        months: {
          0: "January", 1: "February", 2: "March", 3: "April", 4: "May", 5: "June",
          6: "July", 7: "August", 8: "September", 9: "October", 10: "November", 11: "December"
        },
        phoneLabel: "Phone Number",
        phonePlaceholder: "+351 912 345 678",
        promoteAdmin: "Promote to Admin",
        promoteConfirm: "Are you sure you want to promote {name} to Admin? You will no longer be an admin and your session will be terminated.",
        currentAdmin: "Current Administrator",
        adminName: "Name",
        adminEmail: "Email",
        adminPhone: "Phone"
      },
      fr: {
        dashboard: "Tableau de bord",
        condo: "Copropriété",
        documents: "Documents",
        expenses: "Dépenses",
        budgets: "Budgets",
        currentAccount: "Compte Courant",
        fractions: "Unités",
        settings: "Paramètres",
        summary: "Résumé",
        logout: "Déconnexion",
        save: "Enregistrer les modifications",
        saving: "Enregistrement...",
        profileSaved: "Profil enregistré !",
        errorSaving: "Erreur lors de l'enregistrement.",
        nameLabel: "Votre nom",
        languageLabel: "Langue Préférée",
        globalVision: "Aperçu global da copropriété",
        collectedFund: "Fonds Collectés",
        overdueQuotas: "Charges Impayées",
        pendingExpenses: "Dépenses en Attente",
        budgetedOf: "Sur {amount} € budgétisés",
        toReceive: "Montant à recevoir",
        waitingApproval: "En attente d'approbation",
        hello: "Bonjour, {name}",
        unitSummary: "Résumé de votre unité ({unit})",
        amountToPay: "Montant à Payer",
        regularSituation: "Situation Régulière",
        overdueMonths: "Mois de retard",
        months: {
          0: "Janvier", 1: "Février", 2: "Mars", 3: "Avril", 4: "Mai", 5: "Juin",
          6: "Juillet", 7: "Août", 8: "Septembre", 9: "Outubro", 10: "Novembre", 11: "Décembre"
        },
        phoneLabel: "Numéro de Téléphone",
        phonePlaceholder: "+351 912 345 678",
        promoteAdmin: "Promouvoir en tant qu'Administrateur",
        promoteConfirm: "Êtes-vous sûr de vouloir promouvoir {name} au rang d'Administrateur ? Vous ne serez plus administrateur et votre session sera terminée.",
        currentAdmin: "Administrateur Actuel",
        adminName: "Nom",
        adminEmail: "E-mail",
        adminPhone: "Téléphone"
      }
    };

    function App() {
      const [firebaseUser, setFirebaseUser] = useState(null);
      const [isFirebaseReady, setIsFirebaseReady] = useState(false);
      const [currentUser, setCurrentUser] = useState(null);
      const [activeTab, setActiveTab] = useState('dashboard');
      const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
      const [lang, setLang] = useState('pt');

      const t = (key, params = {}) => {
        let text = translations[lang]?.[key] || translations['pt'][key] || key;
        
        // Se a chave for complexa (ex: months.0), aceder ao objeto
        if (key.includes('.')) {
          const parts = key.split('.');
          let current = translations[lang] || translations['pt'];
          for (const part of parts) {
            current = current?.[part];
          }
          if (typeof current === 'string') text = current;
          else if (current === undefined) text = key;
        }

        Object.keys(params).forEach(p => {
          text = text.replace(`{${p}}`, params[p]);
        });
        return text;
      };

      useEffect(() => {
        if (currentUser?.language && currentUser.language !== lang) {
          setLang(currentUser.language);
        }
      }, [currentUser]);

      const [users, setUsers] = useState([]);
      const [quotas, setQuotas] = useState([]);
      const [expenses, setExpenses] = useState([]);
      const [budgets, setBudgets] = useState([]);
      const [documents, setDocuments] = useState([]);
      const [docTypes, setDocTypes] = useState([]);
      const [condo, setCondo] = useState(null);

      useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
          setFirebaseUser(user);
          if (user) {
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', user.uid);
            onSnapshot(userDocRef, (docSnap) => {
              if (docSnap.exists()) {
                setCurrentUser({ firestoreId: docSnap.id, ...docSnap.data() });
              }
            });
          } else {
            setCurrentUser(null);
          }
          setIsFirebaseReady(true);
        });
        return () => unsubscribe();
      }, []);

      useEffect(() => {
        if (!firebaseUser) return;
        const getCol = (colName) => collection(db, 'artifacts', appId, 'public', 'data', colName);

        const unsubUsers = onSnapshot(getCol('users'), (snap) => setUsers(snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }))));
        const unsubQuotas = onSnapshot(getCol('quotas'), (snap) => setQuotas(snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }))));
        const unsubExpenses = onSnapshot(getCol('expenses'), (snap) => setExpenses(snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }))));
        const unsubBudgets = onSnapshot(getCol('budgets'), (snap) => setBudgets(snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }))));
        const unsubDocs = onSnapshot(getCol('documents'), (snap) => setDocuments(snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }))));
        const unsubDocTypes = onSnapshot(getCol('docTypes'), (snap) => setDocTypes(snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }))));
        const unsubCondo = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'condo', 'info'), (docSnap) => {
          if (docSnap.exists()) {
            setCondo({ firestoreId: docSnap.id, ...docSnap.data() });
          }
        });

        return () => { unsubUsers(); unsubQuotas(); unsubExpenses(); unsubBudgets(); unsubDocs(); unsubDocTypes(); unsubCondo(); };
      }, [firebaseUser]);

      const handleLogout = () => signOut(auth);

      // Verificação de configuração ausente (Útil para debugar)
      if (Object.keys(firebaseConfig).length === 0) {
        return <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-50 p-6 text-center">
          <AlertCircle className="w-12 h-12 text-red-500 mb-4" />
          <h2 className="text-xl font-bold text-slate-800">Firebase não configurado</h2>
          <p className="text-slate-500 mt-2">A aguardar injeção das variáveis de ambiente ou atualização do JSON.</p>
        </div>;
      }

      if (!isFirebaseReady) return <div className="h-screen w-full flex items-center justify-center bg-slate-50">A carregar o sistema...</div>;
      if (!firebaseUser || !currentUser) return <LoginScreen />;

      const isAdmin = currentUser.role === 'admin';

      const renderContent = () => {
        switch (activeTab) {
          case 'dashboard': return isAdmin ? <AdminDashboard expenses={expenses} quotas={quotas} users={users} budgets={budgets} t={t} /> : <UserDashboard user={currentUser} quotas={quotas} expenses={expenses} budgets={budgets} users={users} t={t} />;
          case 'condo': return <CondoPage condo={condo} isAdmin={isAdmin} db={db} appId={appId} users={users} t={t} />;
          case 'documentos': return <DocumentsPage documents={documents} docTypes={docTypes} isAdmin={isAdmin} currentUser={currentUser} db={db} appId={appId} storage={storage} />;
          case 'despesas': return <ExpensesPage expenses={expenses} isAdmin={isAdmin} currentUser={currentUser} db={db} appId={appId} />;
          case 'orcamentos': return <BudgetsPage budgets={budgets} isAdmin={isAdmin} db={db} appId={appId} />;
          case 'conta-corrente': return isAdmin ? <CurrentAccountPage budgets={budgets} users={users} quotas={quotas} isAdmin={isAdmin} db={db} appId={appId} condo={condo} t={t} /> : null;
          case 'fracoes': return <FractionsPage users={users} quotas={quotas} isAdmin={isAdmin} db={db} appId={appId} budgets={budgets} currentUser={currentUser} t={t} />;
          case 'definicoes': return <SettingsPage currentUser={currentUser} db={db} appId={appId} t={t} />;
          default: return <AdminDashboard />;
        }
      };

      return (
        <div className="flex h-screen bg-slate-50 font-sans text-slate-800 safe-pl safe-pr">
          {isMobileMenuOpen && <div className="fixed inset-0 bg-slate-800/60 z-40 lg:hidden backdrop-blur-sm transition-opacity" onClick={() => setIsMobileMenuOpen(false)} />}
          
          <aside className={`fixed inset-y-0 left-0 z-50 w-72 bg-white shadow-2xl transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:flex lg:flex-col lg:shadow-none lg:border-r lg:border-slate-200 safe-pt safe-pb flex flex-col ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full'}`}>
            <div className="flex items-center justify-between h-16 px-6 border-b border-slate-100 shrink-0">
              <div className="flex items-center gap-2">
                <div className="bg-blue-600 p-1.5 rounded-lg"><Home className="w-5 h-5 text-white" /></div>
                <span className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-700 to-blue-500">VizinhAI</span>
              </div>
              <button className="lg:hidden text-slate-400 p-2 hover:bg-slate-100 rounded-full" onClick={() => setIsMobileMenuOpen(false)}><X className="w-6 h-6" /></button>
            </div>
            
            <nav className="flex-1 px-4 py-6 space-y-2 overflow-y-auto">
              <NavItem icon={<PieChart />} label={t('summary')} active={activeTab === 'dashboard'} onClick={() => { setActiveTab('dashboard'); setIsMobileMenuOpen(false); }} />
              <NavItem icon={<Home />} label={t('condo')} active={activeTab === 'condo'} onClick={() => { setActiveTab('condo'); setIsMobileMenuOpen(false); }} />
              <NavItem icon={<FolderOpen />} label={t('documents')} active={activeTab === 'documentos'} onClick={() => { setActiveTab('documentos'); setIsMobileMenuOpen(false); }} />
              <NavItem icon={<Receipt />} label={t('expenses')} active={activeTab === 'despesas'} onClick={() => { setActiveTab('despesas'); setIsMobileMenuOpen(false); }} />
              <NavItem icon={<Wallet />} label={t('budgets')} active={activeTab === 'orcamentos'} onClick={() => { setActiveTab('orcamentos'); setIsMobileMenuOpen(false); }} />
              {isAdmin && <NavItem icon={<TrendingUp />} label={t('currentAccount')} active={activeTab === 'conta-corrente'} onClick={() => { setActiveTab('conta-corrente'); setIsMobileMenuOpen(false); }} />}
              <NavItem icon={<Users />} label={t('fractions')} active={activeTab === 'fracoes'} onClick={() => { setActiveTab('fracoes'); setIsMobileMenuOpen(false); }} />
            </nav>
            
            <div className="p-4 border-t border-slate-100 shrink-0">
              <NavItem icon={<Settings />} label={t('settings')} active={activeTab === 'definicoes'} onClick={() => { setActiveTab('definicoes'); setIsMobileMenuOpen(false); }} />
              <div className="flex items-center gap-3 px-4 py-3 bg-slate-50 rounded-xl mt-2 mb-4">
                <div className="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-lg">
                  {currentUser?.name?.charAt(0) || 'U'}
                </div>
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-semibold text-slate-900 truncate">{currentUser?.name}</p>
                  <p className="text-xs text-slate-500 truncate">{currentUser?.fraction} ({currentUser?.permilagem || 0}‰) • {isAdmin ? 'Admin' : 'Condómino'}</p>
                </div>
              </div>
              <button onClick={handleLogout} className="flex items-center gap-3 w-full px-4 py-3 text-sm font-medium text-red-600 rounded-xl hover:bg-red-50 transition-colors">
                <LogOut className="w-5 h-5" /> {t('logout')}
              </button>
            </div>
          </aside>

          <main className="flex-1 flex flex-col min-w-0 h-full overflow-hidden relative">
            <header className="mobile-header bg-blue-600 text-white h-16 flex items-center justify-between px-4 lg:hidden shrink-0 shadow-md">
              <button onClick={() => setIsMobileMenuOpen(true)} className="p-2 -ml-2 text-white hover:bg-blue-700 rounded-full transition-colors"><Menu className="w-6 h-6" /></button>
              <span className="font-semibold text-lg tracking-wide">VizinhAI</span>
              <div className="w-6" />
            </header>

            <div className="flex-1 overflow-y-auto p-4 md:p-8 safe-pb bg-slate-50/50">
              <div className="max-w-5xl mx-auto pb-6">
                {renderContent()}
              </div>
            </div>
          </main>
        </div>
      );
    }

    function LoginScreen() {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true); setError('');
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
          setError('Credenciais incorretas ou conta inexistente.');
        } finally {
          setLoading(false);
        }
      };

      return (
        <div className="min-h-screen bg-slate-50 flex flex-col justify-center items-center p-4 safe-pt safe-pb">
          <div className="w-full max-w-md bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100">
            <div className="bg-blue-600 px-6 py-10 text-center relative overflow-hidden">
              <div className="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 rounded-full bg-blue-500 opacity-20"></div>
              <div className="absolute bottom-0 left-0 -ml-8 -mb-8 w-24 h-24 rounded-full bg-blue-700 opacity-20"></div>
              
              <div className="bg-white/20 w-20 h-20 rounded-2xl flex items-center justify-center mx-auto mb-6 backdrop-blur-sm shadow-inner relative z-10">
                <Home className="w-10 h-10 text-white" />
              </div>
              <h1 className="text-3xl font-bold text-white tracking-tight relative z-10">VizinhAI</h1>
              <p className="text-blue-100 mt-2 text-sm font-medium relative z-10">A gestão do seu condomínio na palma da mão.</p>
            </div>
            
            <div className="p-8">
              {error && <div className="mb-6 p-4 bg-red-50 text-red-700 border border-red-100 rounded-xl text-sm flex items-start gap-3"><AlertCircle className="w-5 h-5 shrink-0" /><span>{error}</span></div>}
              
              <form onSubmit={handleLogin} className="space-y-5">
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2 ml-1">E-mail</label>
                  <input type="email" required className="w-full px-5 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="O seu e-mail" />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2 ml-1">Palavra-passe</label>
                  <input type="password" required className="w-full px-5 py-3.5 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="••••••••" />
                </div>
                <div className="pt-2">
                  <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-xl transition-colors shadow-lg shadow-blue-600/20 disabled:opacity-70 flex justify-center items-center gap-2">
                    {loading ? <span className="animate-pulse">A entrar...</span> : 'Iniciar Sessão'}
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      );
    }

    function NavItem({ icon, label, active, onClick }) {
      return (
        <button onClick={onClick} className={`w-full flex items-center gap-3.5 px-4 py-3.5 rounded-xl transition-all duration-200 text-[15px] font-medium ${active ? 'bg-blue-50 text-blue-700' : 'text-slate-600 hover:bg-slate-50 active:bg-slate-100'}`}>
          {React.cloneElement(icon, { className: `w-[22px] h-[22px] ${active ? 'text-blue-600' : 'text-slate-400'}` })}
          {label}
        </button>
      );
    }

    function AnnualQuotasTable({ currentBudget, users }) {
      if (!currentBudget) return null;

      const rfPerc = currentBudget.reserveFundPercentage ?? 10;
      const totalBudget = currentBudget.totalAmount;

      let grandTotalQuota = 0;
      let grandTotalRF = 0;
      let grandTotal = 0;

      const rows = users.map(user => {
        const perm = parseFloat(user.permilagem) || 0;
        const annualQuota = (totalBudget * (perm / 1000));
        const annualRF = annualQuota * (rfPerc / 100);
        const total = annualQuota + annualRF;

        grandTotalQuota += annualQuota;
        grandTotalRF += annualRF;
        grandTotal += total;

        return {
          fraction: user.fraction,
          perm,
          annualQuota,
          annualRF,
          total
        };
      });

      return (
        <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden mt-6">
          <div className="p-5 border-b border-slate-50 bg-slate-50/50">
            <h3 className="font-bold text-slate-800">Quotas Anuais e Fundo de Reserva</h3>
            <p className="text-xs text-slate-500 mt-1">Valores anuais baseados no orçamento em vigor ({rfPerc}% Fundo de Reserva)</p>
          </div>
          <div className="overflow-x-auto">
            <table className="w-full text-left text-sm border-collapse">
              <thead>
                <tr className="bg-slate-50/30 text-slate-500 border-b border-slate-100">
                  <th className="px-4 py-3.5 font-semibold">Fração</th>
                  <th className="px-4 py-3.5 font-semibold text-center">Permilagem</th>
                  <th className="px-4 py-3.5 font-semibold text-right">Orçamento (€)</th>
                  <th className="px-4 py-3.5 font-semibold text-right">F. Reserva ({rfPerc}%)</th>
                  <th className="px-4 py-3.5 font-semibold text-right font-bold">Total Anual</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {rows.map((row, idx) => (
                  <tr key={idx} className="hover:bg-slate-50/50 transition-colors">
                    <td className="px-4 py-3.5 font-bold text-slate-900">{row.fraction}</td>
                    <td className="px-4 py-3.5 text-center text-slate-600">{row.perm}‰</td>
                    <td className="px-4 py-3.5 text-right text-slate-700">{row.annualQuota.toFixed(2)} €</td>
                    <td className="px-4 py-3.5 text-right text-slate-700">{row.annualRF.toFixed(2)} €</td>
                    <td className="px-4 py-3.5 text-right font-black text-blue-600">{row.total.toFixed(2)} €</td>
                  </tr>
                ))}
                <tr className="bg-blue-50/30 font-bold">
                  <td className="px-4 py-4 text-blue-900">TOTAL GERAL</td>
                  <td className="px-4 py-4 text-center text-blue-900">1000‰</td>
                  <td className="px-4 py-4 text-right text-blue-900">{grandTotalQuota.toFixed(2)} €</td>
                  <td className="px-4 py-4 text-right text-blue-900">{grandTotalRF.toFixed(2)} €</td>
                  <td className="px-4 py-4 text-right text-blue-700 text-lg font-black">{grandTotal.toFixed(2)} €</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      );
    }

    function UserDashboard({ user, quotas, expenses, budgets, users, t }) {
      const [isExpanded, setIsExpanded] = useState(false);
      const sortedBudgets = [...budgets].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      const currentBudget = sortedBudgets[0];

      const getMonths = (start, end) => {
        const months = [];
        if (!start || !end) return months;
        let current = new Date(start);
        const last = new Date(end);
        while (current <= last) {
          months.push(new Date(current));
          current.setMonth(current.getMonth() + 1);
        }
        return months;
      };

      const months = currentBudget ? getMonths(currentBudget.startDate, currentBudget.endDate) : [];
      const rfPerc = currentBudget?.reserveFundPercentage ?? 10;
      const monthlyTotal = currentBudget ? currentBudget.totalAmount / 12 : 0;
      const perm = parseFloat(user.permilagem) || 0;
      const quotaBase = (monthlyTotal * (perm / 1000));
      const reserveFund = quotaBase * (rfPerc / 100);
      const totalMonthly = quotaBase + reserveFund;

      // Calcular meses em dívida até ao mês atual
      const now = new Date();
      const debtMonths = months.filter(m => {
        const monthKey = `${m.getFullYear()}-${m.getMonth()}`;
        const isPaid = quotas.some(q => q.userId === user.firestoreId && q.monthKey === monthKey);
        // Só conta como dívida se o mês já passou ou é o atual, e não está pago
        return !isPaid && (m.getFullYear() < now.getFullYear() || (m.getFullYear() === now.getFullYear() && m.getMonth() <= now.getMonth()));
      });

      const pendingAmount = debtMonths.length * totalMonthly;
      const hasDebt = pendingAmount > 0.01;
      return (
        <div className="space-y-6">
          <div className="pt-2">
            <h2 className="text-[26px] font-bold text-slate-800 tracking-tight">{t('hello', { name: user.name.split(' ')[0] })}</h2>
            <p className="text-slate-500 text-sm mt-1">{t('unitSummary', { unit: user.fraction })}</p>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div 
              onClick={() => hasDebt && setIsExpanded(!isExpanded)}
              className={`p-6 rounded-3xl border transition-all duration-300 ${hasDebt ? 'bg-red-50 border-red-100 cursor-pointer hover:shadow-md' : 'bg-green-50 border-green-100'}`}
            >
              <div className="flex items-start justify-between">
                <div>
                  <p className={`text-sm font-semibold uppercase tracking-wider ${hasDebt ? 'text-red-800/70' : 'text-green-800/70'}`}>{hasDebt ? t('amountToPay') : t('regularSituation')}</p>
                  <h3 className={`text-4xl font-bold mt-2 tracking-tight ${hasDebt ? 'text-red-600' : 'text-green-600'}`}>{pendingAmount.toFixed(2)} €</h3>
                </div>
                <div className={`p-3.5 rounded-2xl ${hasDebt ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>
                  {hasDebt ? (isExpanded ? <ChevronUp className="w-6 h-6" /> : <AlertCircle className="w-6 h-6" />) : <CheckCircle className="w-6 h-6" />}
                </div>
              </div>
              
              {hasDebt && isExpanded && (
                <div className="mt-6 pt-6 border-t border-red-200/50 space-y-3 animate-in fade-in slide-in-from-top-2 duration-300">
                  <p className="text-xs font-bold text-red-800/60 uppercase tracking-widest mb-4">{t('overdueMonths')}</p>
                  {debtMonths.map((m, idx) => (
                    <div key={idx} className="flex justify-between items-center bg-white/40 p-3 rounded-xl border border-red-100/50">
                      <span className="text-sm font-semibold text-red-900 capitalize">
                        {t(`months.${m.getMonth()}`)} {m.getFullYear()}
                      </span>
                      <span className="text-sm font-bold text-red-600">{totalMonthly.toFixed(2)} €</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
          <AnnualQuotasTable currentBudget={currentBudget} users={users} />
        </div>
      );
    }

    function AdminDashboard({ expenses, quotas, users, budgets, t }) {
      const sortedBudgets = [...budgets].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      const currentBudget = sortedBudgets[0];
      const rfPerc = currentBudget?.reserveFundPercentage ?? 10;
      const totalExpected = (currentBudget?.totalAmount || 0) * (1 + rfPerc / 100);
      const pendingExpensesAmount = expenses.filter(e => e.status === 'pending').reduce((acc, curr) => acc + curr.amount, 0);

      // Calcular montante total pago das quotas
      const getMonths = (start, end) => {
        const months = [];
        if (!start || !end) return months;
        let current = new Date(start);
        const last = new Date(end);
        while (current <= last) {
          months.push(new Date(current));
          current.setMonth(current.getMonth() + 1);
        }
        return months;
      };

      const months = currentBudget ? getMonths(currentBudget.startDate, currentBudget.endDate) : [];
      const monthlyTotal = currentBudget ? currentBudget.totalAmount / 12 : 0;
      
      let collectedAmount = 0;
      let totalDebt = 0;
      const now = new Date();

      users.forEach(user => {
        const perm = parseFloat(user.permilagem) || 0;
        const quotaBase = (monthlyTotal * (perm / 1000));
        const reserveFund = quotaBase * (rfPerc / 100);
        const totalMonthly = quotaBase + reserveFund;

        months.forEach(m => {
          const monthKey = `${m.getFullYear()}-${m.getMonth()}`;
          const isPaid = quotas.some(q => q.userId === user.firestoreId && q.monthKey === monthKey);
          
          if (isPaid) {
            collectedAmount += totalMonthly;
          } else if (m.getFullYear() < now.getFullYear() || (m.getFullYear() === now.getFullYear() && m.getMonth() <= now.getMonth())) {
            totalDebt += totalMonthly;
          }
        });
      });

      return (
        <div className="space-y-6">
          <div className="pt-2">
            <h2 className="text-[26px] font-bold text-slate-800 tracking-tight">{t('dashboard')}</h2>
            <p className="text-slate-500 text-sm mt-1">{t('globalVision')}</p>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <StatCard title={t('collectedFund')} value={`${collectedAmount.toFixed(2)} €`} subtitle={t('budgetedOf', { amount: totalExpected.toFixed(2) })} icon={<TrendingUp className="w-6 h-6 text-green-600" />} color="green" />
            <StatCard title={t('overdueQuotas')} value={`${totalDebt.toFixed(2)} €`} subtitle={t('toReceive')} icon={<AlertCircle className="w-6 h-6 text-orange-600" />} color="orange" />
            {/*<StatCard title={t('pendingExpenses')} value={`${pendingExpensesAmount.toFixed(2)} €`} subtitle={t('waitingApproval')} icon={<Clock className="w-6 h-6 text-blue-600" />} color="blue" />*/}
          </div>
          <AnnualQuotasTable currentBudget={currentBudget} users={users} />
        </div>
      );
    }

    function StatCard({ title, value, subtitle, icon, color }) {
      const bgColors = { green: 'bg-green-50 border-green-100', orange: 'bg-orange-50 border-orange-100', blue: 'bg-blue-50 border-blue-100' };
      return (
        <div className={`p-6 rounded-3xl border ${bgColors[color]} shadow-sm`}>
          <div className="flex justify-between items-start">
            <div>
              <p className="text-xs font-semibold uppercase tracking-wider text-slate-600/70 mb-1">{title}</p>
              <h3 className="text-3xl font-bold text-slate-900 tracking-tight">{value}</h3>
              <p className="text-[13px] text-slate-500 mt-2 font-medium">{subtitle}</p>
            </div>
            <div className="p-3 bg-white/80 backdrop-blur-sm rounded-2xl shadow-sm border border-white">{icon}</div>
          </div>
        </div>
      );
    }

    function DocumentsPage({ documents, docTypes, isAdmin, currentUser, db, appId, storage }) {
      const [showForm, setShowForm] = useState(false);
      const [showTypeForm, setShowTypeForm] = useState(false);
      const [newTypeName, setNewTypeName] = useState('');
      const [file, setFile] = useState(null);
      const [selectedType, setSelectedType] = useState('');
      const [docTitle, setDocTitle] = useState('');
      const [loading, setLoading] = useState(false);
      const [editingDoc, setEditingDoc] = useState(null);

      const handleFileUpload = async (e) => {
        e.preventDefault();
        if (!editingDoc && !file) return alert('Por favor selecione um ficheiro');
        if (!selectedType) return alert('Por favor selecione um tipo de documento');
        if (!docTitle) return alert('Por favor introduza um título');

        setLoading(true);
        try {
          let fileUrl = editingDoc?.url || '';
          let fileName = editingDoc?.fileName || '';

          if (file) {
            const timestamp = Date.now();
            fileName = `${timestamp}_${file.name}`;
            const fileRef = ref(storage, `artifacts/${appId}/public/documents/${fileName}`);
            await uploadBytes(fileRef, file);
            fileUrl = await getDownloadURL(fileRef);
          }

          const docData = {
            title: docTitle,
            type: selectedType,
            url: fileUrl,
            fileName: fileName,
            updatedAt: new Date().toISOString(),
            createdBy: currentUser.firestoreId
          };

          if (editingDoc) {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'documents', editingDoc.firestoreId), docData);
          } else {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'documents'), docData);
          }

          setShowForm(false);
          setEditingDoc(null);
          setFile(null);
          setDocTitle('');
          setSelectedType('');
        } catch (err) {
          alert('Erro ao processar documento: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleAddType = async (e) => {
        e.preventDefault();
        if (!newTypeName.trim()) return;
        setLoading(true);
        try {
          await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'docTypes'), {
            name: newTypeName.trim(),
            createdAt: new Date().toISOString()
          });
          setNewTypeName('');
          setShowTypeForm(false);
        } catch (err) {
          alert('Erro ao adicionar tipo: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDeleteType = async (typeId, typeName) => {
        const hasDocs = documents.some(d => d.type === typeName);
        if (hasDocs) return alert('Não é possível eliminar este tipo pois existem documentos associados.');
        if (!confirm('Tem a certeza que deseja eliminar este tipo de documento?')) return;
        
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'docTypes', typeId));
        } catch (err) {
          alert('Erro ao eliminar tipo: ' + err.message);
        }
      };

      const handleDeleteDoc = async (docId) => {
        if (!confirm('Tem a certeza que deseja eliminar este documento?')) return;
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'documents', docId));
        } catch (err) {
          alert('Erro ao eliminar documento: ' + err.message);
        }
      };

      const handleEditDoc = (doc) => {
        setEditingDoc(doc);
        setDocTitle(doc.title);
        setSelectedType(doc.type);
        setShowForm(true);
      };

      // Agrupar documentos por tipo
      const groupedDocs = documents.reduce((acc, doc) => {
        if (!acc[doc.type]) acc[doc.type] = [];
        acc[doc.type].push(doc);
        return acc;
      }, {});

      return (
        <div className="space-y-6">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pt-2">
            <div>
              <h2 className="text-[26px] font-bold text-slate-800 tracking-tight">Documentos</h2>
              <p className="text-slate-500 text-sm mt-1">Partilha de atas, faturas e outros ficheiros</p>
            </div>
            {isAdmin && (
              <div className="flex gap-2 w-full sm:w-auto">
                <button onClick={() => { setShowTypeForm(!showTypeForm); setShowForm(false); }} className="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-white text-slate-700 border border-slate-200 px-4 py-3 rounded-xl font-semibold hover:bg-slate-50 transition-colors">
                  <Settings className="w-5 h-5" /> Tipos
                </button>
                <button onClick={() => { setShowForm(!showForm); setShowTypeForm(false); setEditingDoc(null); setFile(null); setDocTitle(''); setSelectedType(''); }} className="flex-1 sm:flex-none flex items-center justify-center gap-2 bg-blue-600 text-white px-5 py-3 rounded-xl font-semibold hover:bg-blue-700 transition-colors shadow-lg shadow-blue-600/20">
                  {showForm ? <X className="w-5 h-5" /> : <UploadCloud className="w-5 h-5" />} {showForm ? 'Cancelar' : 'Upload'}
                </button>
              </div>
            )}
          </div>

          {showTypeForm && isAdmin && (
            <div className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-4 animate-in fade-in slide-in-from-top-4 duration-300">
              <h3 className="font-bold text-lg text-slate-800">Gerir Tipos de Documentos</h3>
              <form onSubmit={handleAddType} className="flex gap-2">
                <input required placeholder="Novo tipo (ex: Atas, Seguros)" value={newTypeName} onChange={e => setNewTypeName(e.target.value)} className="flex-1 px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                <button type="submit" disabled={loading} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold disabled:opacity-50">Adicionar</button>
              </form>
              <div className="flex flex-wrap gap-2 pt-2">
                {docTypes.map(type => (
                  <div key={type.firestoreId} className="flex items-center gap-2 bg-slate-100 px-3 py-2 rounded-lg group">
                    <span className="text-sm font-medium text-slate-700">{type.name}</span>
                    <button onClick={() => handleDeleteType(type.firestoreId, type.name)} className="text-slate-400 hover:text-red-500 transition-colors">
                      <X className="w-4 h-4" />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {showForm && isAdmin && (
            <form onSubmit={handleFileUpload} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-6 animate-in fade-in slide-in-from-top-4 duration-300">
              <h3 className="font-bold text-lg text-slate-800">{editingDoc ? 'Editar Documento' : 'Novo Documento'}</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1 uppercase">Título do Documento</label>
                  <input required placeholder="Ex: Ata Assembleia Março 2024" value={docTitle} onChange={e => setDocTitle(e.target.value)} className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1 uppercase">Tipo</label>
                  <select required value={selectedType} onChange={e => setSelectedType(e.target.value)} className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 appearance-none">
                    <option value="">Selecionar tipo...</option>
                    {docTypes.map(type => <option key={type.firestoreId} value={type.name}>{type.name}</option>)}
                  </select>
                </div>
                {!editingDoc && (
                  <div className="space-y-1 md:col-span-2">
                    <label className="text-xs font-semibold text-slate-500 ml-1 uppercase">Ficheiro (PDF, Imagem, ZIP)</label>
                    <input required type="file" onChange={e => setFile(e.target.files[0])} className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                  </div>
                )}
                {editingDoc && (
                  <div className="space-y-1 md:col-span-2">
                    <label className="text-xs font-semibold text-slate-500 ml-1 uppercase">Substituir Ficheiro (Opcional)</label>
                    <input type="file" onChange={e => setFile(e.target.files[0])} className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                  </div>
                )}
              </div>
              <div className="flex justify-end gap-3 pt-2">
                <button type="button" onClick={() => setShowForm(false)} className="px-6 py-3 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-xl">Cancelar</button>
                <button type="submit" disabled={loading} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-bold disabled:opacity-50 shadow-lg shadow-slate-900/10">
                  {loading ? 'A processar...' : editingDoc ? 'Atualizar Documento' : 'Submeter Documento'}
                </button>
              </div>
            </form>
          )}

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            {Object.keys(groupedDocs).length > 0 ? Object.keys(groupedDocs).sort().map(type => (
              <div key={type} className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden flex flex-col">
                <div className="p-5 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-100 p-2.5 rounded-2xl text-blue-600">
                      <FolderOpen className="w-6 h-6" />
                    </div>
                    <h3 className="font-bold text-slate-800 text-lg">{type}</h3>
                  </div>
                  <span className="bg-white px-3 py-1 rounded-full text-xs font-bold text-slate-500 border border-slate-100 shadow-sm">
                    {groupedDocs[type].length} {groupedDocs[type].length === 1 ? 'Doc' : 'Docs'}
                  </span>
                </div>
                <div className="p-4 space-y-3 flex-1">
                  {groupedDocs[type].map(doc => (
                    <div key={doc.firestoreId} className="group flex items-center justify-between p-3 rounded-2xl hover:bg-slate-50 transition-all border border-transparent hover:border-slate-100">
                      <div className="flex items-center gap-3 min-w-0">
                        <div className="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center text-slate-400 shrink-0">
                          <FileText className="w-5 h-5" />
                        </div>
                        <div className="min-w-0">
                          <p className="font-bold text-slate-700 text-sm truncate">{doc.title}</p>
                          <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">{new Date(doc.updatedAt).toLocaleDateString()}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <a href={doc.url} target="_blank" rel="noopener noreferrer" className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                          <Download className="w-4 h-4" />
                        </a>
                        {isAdmin && (
                          <>
                            <button onClick={() => handleEditDoc(doc)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                              <Edit2 className="w-4 h-4" />
                            </button>
                            <button onClick={() => handleDeleteDoc(doc.firestoreId)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )) : (
              <div className="md:col-span-2 p-16 text-center bg-white rounded-3xl border border-dashed border-slate-200">
                <div className="bg-slate-50 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <FolderOpen className="w-8 h-8 text-slate-300" />
                </div>
                <p className="text-slate-500 font-medium">Ainda não existem documentos partilhados.</p>
                {isAdmin && <button onClick={() => setShowForm(true)} className="mt-4 text-blue-600 font-bold hover:underline">Fazer o primeiro upload</button>}
              </div>
            )}
          </div>
        </div>
      );
    }

    function CondoPage({ condo, isAdmin, db, appId, users, t }) {
      const [isEditing, setIsEditing] = useState(!condo);
      const [formData, setFormData] = useState(condo || { name: '', address: '', nif: '', iban: '' });
      const [saving, setSaving] = useState(false);

      const currentAdmin = users.find(u => u.role === 'admin');

      useEffect(() => { 
        if (condo) {
          setFormData(condo);
          setIsEditing(false);
        } else if (isAdmin) {
          setIsEditing(true);
        }
      }, [condo, isAdmin]);

      const handleSave = async (e) => {
        e.preventDefault();
        setSaving(true);
        try {
          await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'condo', 'info'), formData);
          setIsEditing(false);
        } catch (err) {
          alert('Erro ao guardar: ' + err.message);
        } finally {
          setSaving(false);
        }
      };

      if (!condo && !isAdmin) return <div className="p-8 text-center bg-white rounded-3xl border border-slate-100 shadow-sm"><AlertCircle className="w-12 h-12 text-orange-400 mx-auto mb-4" /> <p className="text-slate-600 font-medium">Os dados do condomínio ainda não foram configurados pelo administrador.</p></div>;
      if (!condo && !isEditing) return <div className="p-8 text-center">A carregar dados do condomínio...</div>;

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center pt-2">
            <h2 className="text-[26px] font-bold text-slate-800 tracking-tight">Condomínio</h2>
            {isAdmin && !isEditing && (
              <button onClick={() => setIsEditing(true)} className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-700 transition-colors">
                <Settings className="w-4 h-4" /> Editar
              </button>
            )}
          </div>

          {isEditing ? (
            <form onSubmit={handleSave} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-1 ml-1 text-slate-700">Nome do Condomínio</label>
                <input required className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.name || ''} onChange={e => setFormData({...formData, name: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-1 ml-1 text-slate-700">Morada</label>
                <input required className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.address || ''} onChange={e => setFormData({...formData, address: e.target.value})} />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-semibold mb-1 ml-1 text-slate-700">Contribuinte (NIF)</label>
                  <input required className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.nif || ''} onChange={e => setFormData({...formData, nif: e.target.value})} />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-1 ml-1 text-slate-700">IBAN</label>
                  <input required className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={formData.iban || ''} onChange={e => setFormData({...formData, iban: e.target.value})} />
                </div>
              </div>
              <div className="flex gap-3 pt-2">
                <button type="submit" disabled={saving} className="flex-1 bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold disabled:opacity-50">
                  {saving ? 'A guardar...' : 'Guardar Alterações'}
                </button>
                <button type="button" onClick={() => setIsEditing(false)} className="px-6 py-3 border border-slate-200 rounded-xl font-semibold hover:bg-slate-50">Cancelar</button>
              </div>
            </form>
          ) : (
            <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
              <div className="bg-gradient-to-br from-blue-600 to-blue-700 p-8 text-white">
                <div className="flex items-center gap-4 mb-4">
                  <div className="bg-white/20 p-3 rounded-2xl backdrop-blur-sm">
                    <Home className="w-8 h-8 text-white" />
                  </div>
                  <div>
                    <h3 className="text-2xl font-bold leading-tight">{condo.name}</h3>
                    <p className="text-blue-100 mt-1 flex items-center gap-1.5"><Settings className="w-4 h-4" /> Detalhes da Entidade</p>
                  </div>
                </div>
              </div>
              
              <div className="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
                <div className="space-y-1">
                  <p className="text-xs font-semibold uppercase tracking-wider text-slate-400">Morada Oficial</p>
                  <p className="text-slate-700 font-medium text-lg leading-relaxed">{condo.address}</p>
                </div>
                
                <div className="space-y-6">
                  <div className="space-y-1">
                    <p className="text-xs font-semibold uppercase tracking-wider text-slate-400">Contribuinte (NIF)</p>
                    <p className="text-slate-900 font-bold text-xl tracking-tight">{condo.nif}</p>
                  </div>
                  
                  <div className="space-y-1">
                    <p className="text-xs font-semibold uppercase tracking-wider text-slate-400">IBAN para Pagamentos</p>
                    <div className="bg-slate-50 p-4 rounded-2xl border border-slate-100 flex items-center justify-between">
                      <p className="text-blue-700 font-mono font-bold text-lg">{condo.iban}</p>
                      <button onClick={() => {navigator.clipboard.writeText(condo.iban); alert('IBAN copiado!');}} className="text-blue-600 hover:bg-blue-100 p-2 rounded-lg transition-colors">
                         <FileText className="w-5 h-5" />
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {currentAdmin && (
            <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
              <div className="p-6 border-b border-slate-50 bg-slate-50/50 flex items-center gap-3">
                <div className="bg-blue-600 p-2 rounded-lg">
                  <User className="w-5 h-5 text-white" />
                </div>
                <h3 className="font-bold text-slate-800">{t('currentAdmin')}</h3>
              </div>
              <div className="p-6">
                <div className="flex flex-col md:flex-row items-center md:items-start gap-6">
                  <div className="w-24 h-24 rounded-full bg-slate-100 flex items-center justify-center text-slate-300 shrink-0 border-4 border-white shadow-md">
                    <User className="w-12 h-12" />
                  </div>
                  <div className="flex-1 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 w-full">
                    <div className="space-y-1">
                      <p className="text-xs font-semibold uppercase tracking-wider text-slate-400">{t('adminName')}</p>
                      <p className="text-slate-800 font-bold">{currentAdmin.name}</p>
                    </div>
                    <div className="space-y-1">
                      <p className="text-xs font-semibold uppercase tracking-wider text-slate-400">{t('adminEmail')}</p>
                      <p className="text-slate-800 font-bold">{currentAdmin.email}</p>
                    </div>
                    <div className="space-y-1">
                      <p className="text-xs font-semibold uppercase tracking-wider text-slate-400">{t('adminPhone')}</p>
                      <p className="text-slate-800 font-bold">{currentAdmin.phone || '---'}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ExpensesPage({ expenses, isAdmin, currentUser, db, appId }) {
      const [showForm, setShowForm] = useState(false);
      const [editingExpense, setEditingExpense] = useState(null);
      const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
      const [rubric, setRubric] = useState('');
      const [value, setValue] = useState('');
      const [loading, setLoading] = useState(false);
      const [expandedMonths, setExpandedMonths] = useState({});

      useEffect(() => {
        if (editingExpense) {
          setDate(editingExpense.date || '');
          setRubric(editingExpense.rubric || '');
          setValue(editingExpense.amount || '');
          setShowForm(true);
        } else {
          setDate(new Date().toISOString().split('T')[0]);
          setRubric('');
          setValue('');
        }
      }, [editingExpense]);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        const expenseData = {
          date,
          rubric,
          amount: parseFloat(value),
          updatedAt: new Date().toISOString(),
          createdBy: currentUser.firestoreId
        };

        try {
          if (editingExpense) {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', editingExpense.firestoreId), expenseData);
          } else {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'expenses'), expenseData);
          }
          setShowForm(false);
          setEditingExpense(null);
        } catch (err) {
          alert('Erro ao guardar despesa: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Tem a certeza que deseja eliminar esta despesa?')) return;
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'expenses', id));
        } catch (err) {
          alert('Erro ao eliminar: ' + err.message);
        }
      };

      // Agrupar despesas por mês
      const groupedExpenses = expenses.reduce((acc, expense) => {
        const d = new Date(expense.date);
        const monthYear = d.toLocaleString('pt', { month: 'long', year: 'numeric' });
        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
        if (!acc[key]) acc[key] = { label: monthYear, items: [], total: 0 };
        acc[key].items.push(expense);
        acc[key].total += expense.amount;
        return acc;
      }, {});

      const sortedKeys = Object.keys(groupedExpenses).sort((a, b) => b.localeCompare(a));
      const currentMonthKey = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;

      return (
        <div className="space-y-6">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pt-2">
            <div>
              <h2 className="text-[26px] font-bold text-slate-800 tracking-tight">Despesas</h2>
              <p className="text-slate-500 text-sm mt-1">Gestão e histórico de despesas do condomínio</p>
            </div>
            {isAdmin && (
              <button onClick={() => { setShowForm(!showForm); setEditingExpense(null); }} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white px-5 py-3 rounded-xl font-semibold active:bg-blue-700 transition-colors shadow-lg shadow-blue-600/20">
                {showForm ? <X className="w-5 h-5" /> : <Plus className="w-5 h-5" />} {showForm ? 'Cancelar' : 'Nova Despesa'}
              </button>
            )}
          </div>

          {showForm && isAdmin && (
            <form onSubmit={handleSubmit} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-6 animate-in fade-in slide-in-from-top-4 duration-300">
              <h3 className="font-bold text-lg text-slate-800">{editingExpense ? 'Editar Despesa' : 'Nova Despesa'}</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1 uppercase tracking-wider">Data</label>
                  <input required type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div className="space-y-1 md:col-span-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1 uppercase tracking-wider">Rubrica / Descrição</label>
                  <input required placeholder="Ex: Limpeza, Elevador..." value={rubric} onChange={e => setRubric(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1 uppercase tracking-wider">Valor (€)</label>
                  <div className="relative">
                    <input required type="number" step="0.01" placeholder="0.00" value={value} onChange={e => setValue(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all pr-8" />
                    <span className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">€</span>
                  </div>
                </div>
              </div>

              <div className="pt-2 flex justify-end gap-3">
                <button type="button" onClick={() => { setShowForm(false); setEditingExpense(null); }} className="px-6 py-3.5 text-sm font-bold text-slate-500 hover:bg-slate-100 rounded-xl transition-colors">Cancelar</button>
                <button type="submit" disabled={loading} className="bg-slate-900 text-white px-8 py-3.5 rounded-xl font-bold disabled:opacity-50 hover:bg-slate-800 transition-all shadow-lg shadow-slate-900/10">
                  {loading ? 'A processar...' : editingExpense ? 'Atualizar Despesa' : 'Registar Despesa'}
                </button>
              </div>
            </form>
          )}

          <div className="space-y-4">
            {sortedKeys.map((key) => {
              const group = groupedExpenses[key];
              const isCurrent = key === currentMonthKey;
              const isExpanded = expandedMonths[key] !== undefined ? expandedMonths[key] : isCurrent;
              
              return (
                <div key={key} className={`bg-white rounded-3xl border ${isCurrent ? 'border-blue-100 ring-1 ring-blue-50' : 'border-slate-100'} shadow-sm overflow-hidden transition-all`}>
                  <div className={`p-5 flex justify-between items-center cursor-pointer transition-colors ${!isExpanded ? 'hover:bg-slate-50' : ''}`} onClick={() => setExpandedMonths({...expandedMonths, [key]: !isExpanded})}>
                    <div className="flex items-center gap-4">
                      <div className={`p-3 rounded-2xl ${isCurrent ? 'bg-blue-600 text-white shadow-lg shadow-blue-600/20' : 'bg-slate-100 text-slate-500'}`}>
                        <Calendar className="w-6 h-6" />
                      </div>
                      <div>
                        <h3 className="font-bold text-slate-800 capitalize">{group.label}</h3>
                        <p className="text-xs text-slate-500">{group.items.length} despesas registadas</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-6">
                      <div className="text-right hidden sm:block">
                        <p className="text-xs font-semibold uppercase text-slate-400 tracking-wider">Total Mensal</p>
                        <p className={`font-bold ${isCurrent ? 'text-blue-600' : 'text-slate-900'}`}>{group.total.toFixed(2)} €</p>
                      </div>
                      {isExpanded ? <ChevronUp className="w-5 h-5 text-slate-400" /> : <ChevronDown className="w-5 h-5 text-slate-400" />}
                    </div>
                  </div>

                  {isExpanded && (
                    <div className="px-5 pb-6 animate-in fade-in duration-300">
                      <div className="bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
                        <table className="w-full text-left text-sm">
                          <thead>
                            <tr className="bg-slate-100/50 text-slate-500 border-b border-slate-200">
                              <th className="px-4 py-3.5 font-semibold">Data</th>
                              <th className="px-4 py-3.5 font-semibold">Rubrica</th>
                              <th className="px-4 py-3.5 font-semibold text-right">Valor</th>
                              {isAdmin && <th className="px-4 py-3.5 font-semibold text-center w-24">Ações</th>}
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100">
                            {group.items.sort((a,b) => new Date(b.date) - new Date(a.date)).map((item) => (
                              <tr key={item.firestoreId} className="hover:bg-white/50 transition-colors">
                                <td className="px-4 py-3.5 text-slate-500 font-medium">{new Date(item.date).toLocaleDateString('pt')}</td>
                                <td className="px-4 py-3.5 text-slate-700 font-bold">{item.rubric}</td>
                                <td className="px-4 py-3.5 text-slate-900 font-black text-right">{item.amount.toFixed(2)} €</td>
                                {isAdmin && (
                                  <td className="px-4 py-3.5">
                                    <div className="flex items-center justify-center gap-1">
                                      <button onClick={() => setEditingExpense(item)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"><Edit2 className="w-4 h-4" /></button>
                                      <button onClick={() => handleDelete(item.firestoreId)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                  </td>
                                )}
                              </tr>
                            ))}
                            <tr className="bg-blue-50/30">
                              <td colSpan="2" className="px-4 py-4 text-blue-900 font-bold text-right">Total do Mês</td>
                              <td className="px-4 py-4 text-blue-700 font-black text-right text-lg">{group.total.toFixed(2)} €</td>
                              {isAdmin && <td></td>}
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
            
            {expenses.length === 0 && (
              <div className="p-16 text-center bg-white rounded-3xl border border-dashed border-slate-200">
                <div className="bg-slate-50 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <Receipt className="w-8 h-8 text-slate-300" />
                </div>
                <p className="text-slate-500 font-medium">Não existem despesas registadas.</p>
                {isAdmin && <button onClick={() => setShowForm(true)} className="mt-4 text-blue-600 font-bold hover:underline">Registar a primeira despesa</button>}
              </div>
            )}
          </div>
        </div>
      );
    }

    function BudgetsPage({ budgets, isAdmin, db, appId }) {
      const [showForm, setShowForm] = useState(false);
      const [editingBudget, setEditingBudget] = useState(null);
      const [startDate, setStartDate] = useState('');
      const [endDate, setEndDate] = useState('');
      const [rubrics, setRubrics] = useState([{ name: '', value: '' }]);
      const [reserveFundPercentage, setReserveFundPercentage] = useState(10);
      const [loading, setLoading] = useState(false);
      const [expandedId, setExpandedId] = useState(null);

      const sortedBudgets = [...budgets].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      const currentBudget = sortedBudgets[0];

      useEffect(() => {
        if (editingBudget) {
          setStartDate(editingBudget.startDate || '');
          setEndDate(editingBudget.endDate || '');
          setRubrics(editingBudget.rubrics || [{ name: '', value: '' }]);
          setReserveFundPercentage(editingBudget.reserveFundPercentage ?? 10);
          setShowForm(true);
        } else {
          setStartDate('');
          setEndDate('');
          setRubrics([{ name: '', value: '' }]);
          setReserveFundPercentage(10);
        }
      }, [editingBudget]);

      const handleAddRubric = () => {
        setRubrics([...rubrics, { name: '', value: '' }]);
      };

      const handleRemoveRubric = (index) => {
        setRubrics(rubrics.filter((_, i) => i !== index));
      };

      const handleRubricChange = (index, field, value) => {
        const newRubrics = [...rubrics];
        newRubrics[index][field] = value;
        setRubrics(newRubrics);
      };

      const calculateTotal = (items) => {
        return items.reduce((acc, curr) => acc + (parseFloat(curr.value) || 0), 0);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        const totalAmount = calculateTotal(rubrics);
        const budgetData = {
          startDate,
          endDate,
          rubrics: rubrics.map(r => ({ name: r.name, value: parseFloat(r.value) || 0 })),
          reserveFundPercentage: parseFloat(reserveFundPercentage) || 0,
          totalAmount,
          updatedAt: new Date().toISOString()
        };

        try {
          if (editingBudget) {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'budgets', editingBudget.firestoreId), budgetData);
          } else {
            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'budgets'), budgetData);
          }
          setShowForm(false);
          setEditingBudget(null);
        } catch (err) {
          alert('Erro ao guardar orçamento: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleDelete = async (id) => {
        if (!confirm('Tem a certeza que deseja eliminar este orçamento?')) return;
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'budgets', id));
        } catch (err) {
          alert('Erro ao eliminar: ' + err.message);
        }
      };

      return (
        <div className="space-y-6">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pt-2">
            <div>
              <h2 className="text-[26px] font-bold text-slate-800">Orçamentos</h2>
              <p className="text-slate-500 text-sm mt-1">Gestão de orçamentos e exercício</p>
            </div>
            {isAdmin && (
              <button onClick={() => { setShowForm(!showForm); setEditingBudget(null); }} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white px-5 py-3 rounded-xl font-semibold active:bg-blue-700 transition-colors">
                {showForm ? <X className="w-5 h-5" /> : <Plus className="w-5 h-5" />} {showForm ? 'Cancelar' : 'Novo Orçamento'}
              </button>
            )}
          </div>

          {showForm && isAdmin && (
            <form onSubmit={handleSubmit} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-6">
              <h3 className="font-semibold text-lg">{editingBudget ? 'Editar Orçamento' : 'Novo Orçamento'}</h3>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1">Data de Início</label>
                  <input required type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1">Data de Fim</label>
                  <input required type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
              </div>

              <div className="space-y-1">
                <label className="text-xs font-semibold text-slate-500 ml-1">Fundo de Reserva (%)</label>
                <div className="w-full sm:w-32 relative">
                  <input required type="number" step="0.1" value={reserveFundPercentage} onChange={e => setReserveFundPercentage(e.target.value)} className="w-full px-4 py-3 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500 pr-8" />
                  <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">%</span>
                </div>
              </div>

              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <label className="text-sm font-semibold text-slate-700 ml-1">Rubricas</label>
                  <button type="button" onClick={handleAddRubric} className="text-sm text-blue-600 font-bold flex items-center gap-1"><Plus className="w-4 h-4" /> Adicionar Linha</button>
                </div>
                {rubrics.map((rubric, index) => (
                  <div key={index} className="flex gap-2 items-start">
                    <input required placeholder="Descrição da Rubrica" value={rubric.name} onChange={e => handleRubricChange(index, 'name', e.target.value)} className="flex-1 px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                    <div className="w-32 relative">
                      <input required type="number" step="0.01" placeholder="0.00" value={rubric.value} onChange={e => handleRubricChange(index, 'value', e.target.value)} className="w-full px-4 py-3 border border-slate-200 bg-slate-50 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 pr-8" />
                      <span className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">€</span>
                    </div>
                    {rubrics.length > 1 && (
                      <button type="button" onClick={() => handleRemoveRubric(index)} className="p-3 text-red-500 hover:bg-red-50 rounded-xl"><Trash2 className="w-5 h-5" /></button>
                    )}
                  </div>
                ))}
              </div>

              <div className="pt-4 border-t border-slate-100 flex justify-between items-center">
                <span className="font-bold text-slate-700">Total: {calculateTotal(rubrics).toFixed(2)} €</span>
                <button type="submit" disabled={loading} className="bg-slate-900 text-white px-8 py-3 rounded-xl font-semibold disabled:opacity-50">
                  {loading ? 'A processar...' : 'Submeter Orçamento'}
                </button>
              </div>
            </form>
          )}

          <div className="space-y-4">
            {sortedBudgets.map((budget, index) => {
              const isCurrent = index === 0;
              const isExpanded = expandedId === budget.firestoreId || isCurrent;
              
              return (
                <div key={budget.firestoreId} className={`bg-white rounded-3xl border ${isCurrent ? 'border-blue-100 ring-1 ring-blue-50' : 'border-slate-100'} shadow-sm overflow-hidden`}>
                  <div className={`p-5 flex justify-between items-center cursor-pointer ${!isCurrent ? 'hover:bg-slate-50' : ''}`} onClick={() => !isCurrent && setExpandedId(expandedId === budget.firestoreId ? null : budget.firestoreId)}>
                    <div className="flex items-center gap-4">
                      <div className={`p-3 rounded-2xl ${isCurrent ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500'}`}>
                        <Calendar className="w-6 h-6" />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <h3 className="font-bold text-slate-800">{new Date(budget.startDate).getFullYear()} - {new Date(budget.endDate).getFullYear()}</h3>
                          {isCurrent && <span className="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full font-bold uppercase">Atual</span>}
                        </div>
                        <p className="text-xs text-slate-500">{new Date(budget.startDate).toLocaleDateString()} até {new Date(budget.endDate).toLocaleDateString()}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-4">
                      <div className="text-right hidden sm:block">
                        <p className="text-xs font-semibold uppercase text-slate-400 tracking-wider">Total</p>
                        <p className="font-bold text-slate-900">{budget.totalAmount.toFixed(2)} €</p>
                      </div>
                      <div className="flex items-center gap-2">
                        {isAdmin && (
                          <>
                            <button onClick={(e) => { e.stopPropagation(); setEditingBudget(budget); }} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg"><Edit2 className="w-4 h-4" /></button>
                            <button onClick={(e) => { e.stopPropagation(); handleDelete(budget.firestoreId); }} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg"><Trash2 className="w-4 h-4" /></button>
                          </>
                        )}
                        {!isCurrent && (isExpanded ? <ChevronUp className="w-5 h-5 text-slate-400" /> : <ChevronDown className="w-5 h-5 text-slate-400" />)}
                      </div>
                    </div>
                  </div>

                  {isExpanded && (
                    <div className="px-5 pb-6">
                      <div className="bg-slate-50 rounded-2xl overflow-hidden border border-slate-100">
                        <table className="w-full text-left text-sm">
                          <thead>
                            <tr className="bg-slate-100/50 text-slate-500 border-b border-slate-200">
                              <th className="px-4 py-3 font-semibold">Rubrica</th>
                              <th className="px-4 py-3 font-semibold text-right">Valor</th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-100">
                            {budget.rubrics.map((rubric, ridx) => (
                              <tr key={ridx}>
                                <td className="px-4 py-3 text-slate-700 font-medium">{rubric.name}</td>
                                <td className="px-4 py-3 text-slate-900 font-bold text-right">{rubric.value.toFixed(2)} €</td>
                              </tr>
                            ))}
                            <tr>
                              <td className="px-4 py-3 text-slate-700 font-medium">Fundo de Reserva ({budget.reserveFundPercentage ?? 10}%)</td>
                              <td className="px-4 py-3 text-slate-900 font-bold text-right">{(budget.totalAmount * ((budget.reserveFundPercentage ?? 10) / 100)).toFixed(2)} €</td>
                            </tr>
                            <tr className="bg-blue-50/30">
                              <td className="px-4 py-4 text-blue-900 font-bold">Total do Exercício (+ FR)</td>
                              <td className="px-4 py-4 text-blue-700 font-black text-right text-lg">{(budget.totalAmount * (1 + (budget.reserveFundPercentage ?? 10) / 100)).toFixed(2)} €</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
            {sortedBudgets.length === 0 && (
              <div className="p-12 text-center bg-white rounded-3xl border border-dashed border-slate-200">
                <Wallet className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                <p className="text-slate-500 font-medium">Não existem orçamentos registados.</p>
              </div>
            )}
          </div>
        </div>
      );
    }

    function FractionsPage({ users, quotas, isAdmin, db, appId, budgets, currentUser, t }) {
      const [showForm, setShowForm] = useState(false);
      const [editingUser, setEditingUser] = useState(null);
      const [newName, setNewName] = useState('');
      const [newEmail, setNewEmail] = useState('');
      const [newFraction, setNewFraction] = useState('');
      const [newPermilagem, setNewPermilagem] = useState('');
      const [newPhone, setNewPhone] = useState('');
      const [msg, setMsg] = useState({ type: '', text: '' });
      const [loading, setLoading] = useState(false);

      const sortedBudgets = [...budgets].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      const currentBudget = sortedBudgets[0];
      const rfPerc = currentBudget?.reserveFundPercentage ?? 10;
      const monthlyTotal = currentBudget ? currentBudget.totalAmount / 12 : 0;

      const getMonths = (start, end) => {
        const months = [];
        if (!start || !end) return months;
        let current = new Date(start);
        const last = new Date(end);
        while (current <= last) {
          months.push(new Date(current));
          current.setMonth(current.getMonth() + 1);
        }
        return months;
      };
      const months = currentBudget ? getMonths(currentBudget.startDate, currentBudget.endDate) : [];
      const now = new Date();

      useEffect(() => {
        if (editingUser) {
          setNewName(editingUser.name || '');
          setNewEmail(editingUser.email || '');
          setNewFraction(editingUser.fraction || '');
          setNewPermilagem(editingUser.permilagem || '');
          setNewPhone(editingUser.phone || '');
          setShowForm(true);
        } else {
          setNewName('');
          setNewEmail('');
          setNewFraction('');
          setNewPermilagem('');
          setNewPhone('');
        }
      }, [editingUser]);

      const handlePromoteAdmin = async (user) => {
        if (!confirm(t('promoteConfirm', { name: user.name }))) return;
        setLoading(true);
        try {
          // 1. Promover o novo utilizador
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.firestoreId), {
            role: 'admin'
          });
          // 2. Despromover o administrador atual
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.firestoreId), {
            role: 'user'
          });
          // 3. Terminar sessão
          await signOut(auth);
        } catch (err) {
          alert('Erro ao promover administrador: ' + err.message);
          setLoading(false);
        }
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true); setMsg({ type: '', text: '' });
        try {
          if (editingUser) {
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', editingUser.firestoreId), {
              name: newName,
              fraction: newFraction,
              permilagem: parseFloat(newPermilagem) || 0,
              phone: newPhone,
            });
            setMsg({ type: 'success', text: 'Condómino atualizado!' });
            setTimeout(() => { setShowForm(false); setEditingUser(null); }, 2000);
          } else {
            const secondaryApp = initializeApp(firebaseConfig, `TempApp-${Date.now()}`);
            const secondaryAuth = getAuth(secondaryApp);
            const tempPassword = Math.random().toString(36).slice(-10) + "A1!";
            const userCred = await createUserWithEmailAndPassword(secondaryAuth, newEmail, tempPassword);

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', userCred.user.uid), {
              id: userCred.user.uid, 
              name: newName, 
              email: newEmail, 
              fraction: newFraction, 
              permilagem: parseFloat(newPermilagem) || 0,
              phone: newPhone,
              role: 'user', 
              condoId: appId
            });
            await sendPasswordResetEmail(auth, newEmail);
            await signOut(secondaryAuth);
            
            setMsg({ type: 'success', text: 'Condómino adicionado!' });
            setNewName(''); setNewEmail(''); setNewFraction(''); setNewPermilagem(''); setNewPhone('');
            setTimeout(() => setShowForm(false), 2000);
          }
        } catch (err) {
          setMsg({ type: 'error', text: 'Erro: ' + err.message });
        } finally {
          setLoading(false);
        }
      };

      const handleDeleteUser = async (user) => {
        if (!confirm(`Tem a certeza que deseja eliminar o utilizador ${user.name}? Esta ação não pode ser desfeita na base de dados.`)) return;
        
        try {
          await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', user.firestoreId));
          alert('Utilizador eliminado com sucesso.');
        } catch (err) {
          alert('Erro ao eliminar: ' + err.message);
        }
      };

      const fractionsList = users.map(user => {
        const perm = parseFloat(user.permilagem) || 0;
        const quotaBase = (monthlyTotal * (perm / 1000));
        const reserveFund = quotaBase * (rfPerc / 100);
        const totalMonthly = quotaBase + reserveFund;

        const debtMonths = months.filter(m => {
          const monthKey = `${m.getFullYear()}-${m.getMonth()}`;
          const isPaid = quotas.some(q => q.userId === user.firestoreId && q.monthKey === monthKey);
          return !isPaid && (m.getFullYear() < now.getFullYear() || (m.getFullYear() === now.getFullYear() && m.getMonth() <= now.getMonth()));
        });

        const debt = debtMonths.length * totalMonthly;
        return { ...user, debt };
      });

      return (
        <div className="space-y-6">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 pt-2">
            <div><h2 className="text-[26px] font-bold text-slate-800">Frações</h2></div>
            {isAdmin && (
              <button onClick={() => { setShowForm(!showForm); setEditingUser(null); }} className="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 text-white px-5 py-3 rounded-xl font-semibold active:bg-blue-700 transition-colors">
                {showForm ? <X className="w-5 h-5" /> : <Plus className="w-5 h-5" />} {showForm ? 'Cancelar' : 'Adicionar'}
              </button>
            )}
          </div>

          {showForm && isAdmin && (
            <form onSubmit={handleSubmit} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
              <h3 className="font-semibold mb-5 text-lg">{editingUser ? 'Editar Condómino' : 'Novo Condómino'}</h3>
              {msg.text && <div className={`mb-5 p-4 rounded-xl text-sm font-medium ${msg.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>{msg.text}</div>}
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1">Nome</label>
                  <input required type="text" placeholder="Nome completo" value={newName} onChange={e => setNewName(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1">E-mail</label>
                  <input required type="email" placeholder="E-mail" value={newEmail} onChange={e => setNewEmail(e.target.value)} disabled={!!editingUser} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50" />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1">Fração</label>
                  <input required type="text" placeholder="Fração (Ex: 1º Esq)" value={newFraction} onChange={e => setNewFraction(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1">Permilagem</label>
                  <input required type="number" step="0.01" placeholder="Permilagem (Ex: 15.5)" value={newPermilagem} onChange={e => setNewPermilagem(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div className="space-y-1">
                  <label className="text-xs font-semibold text-slate-500 ml-1">{t('phoneLabel')}</label>
                  <input type="text" placeholder={t('phonePlaceholder')} value={newPhone} onChange={e => setNewPhone(e.target.value)} className="w-full px-4 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
              </div>
              <button type="submit" disabled={loading} className="mt-5 w-full bg-slate-900 text-white px-6 py-4 rounded-xl font-semibold disabled:opacity-50 transition-all active:scale-[0.98]">
                {loading ? 'A processar...' : (editingUser ? 'Atualizar Dados' : 'Guardar Condómino')}
              </button>
            </form>
          )}

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            {fractionsList.map(frac => (
              <div key={frac.firestoreId} className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex flex-col justify-between group">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="font-bold text-xl tracking-tight">{frac.fraction}</h3>
                    <p className="text-slate-500 text-[15px] mt-1">{frac.name}</p>
                    <p className="text-slate-400 text-xs mt-1 font-medium">{frac.email}</p>
                    {frac.phone && <p className="text-slate-400 text-xs mt-1 font-medium">{frac.phone}</p>}
                    <p className="text-slate-400 text-xs mt-1 font-medium">Permilagem: {frac.permilagem || 0} ‰</p>
                  </div>
                  <div className="flex flex-col items-end gap-2">
                    {frac.role === 'admin' ? (
                      <span className="bg-blue-50 text-blue-700 text-[10px] px-2 py-1 rounded-lg font-bold tracking-wide uppercase">Admin</span>
                    ) : (
                      isAdmin && (
                        <button 
                          onClick={() => handlePromoteAdmin(frac)}
                          className="bg-slate-50 text-slate-600 hover:bg-blue-50 hover:text-blue-700 text-[10px] px-2 py-1 rounded-lg font-bold tracking-wide uppercase transition-colors"
                        >
                          {t('promoteAdmin')}
                        </button>
                      )
                    )}
                    {isAdmin && (
                      <div className="flex gap-1">
                        <button onClick={() => setEditingUser(frac)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all" title="Editar">
                          <Edit2 className="w-4 h-4" />
                        </button>
                        <button onClick={() => handleDeleteUser(frac)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-xl transition-all" title="Eliminar">
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    )}
                  </div>
                </div>
                <div className="pt-4 border-t border-slate-100 flex justify-between items-center">
                  <span className="text-sm font-medium text-slate-400">Estado</span>
                  {frac.debt > 0 ? <span className="text-red-600 font-bold bg-red-50 px-3 py-1.5 rounded-xl text-sm">Em dívida</span> : <span className="text-green-600 font-bold bg-green-50 px-3 py-1.5 rounded-xl text-sm">Regular</span>}
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    function CurrentAccountPage({ budgets, users, quotas, isAdmin, db, appId, condo, t }) {
      const sortedBudgets = [...budgets].sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      const currentBudget = sortedBudgets[0];

      if (!currentBudget) {
        return (
          <div className="p-12 text-center bg-white rounded-3xl border border-dashed border-slate-200">
            <Wallet className="w-12 h-12 text-slate-300 mx-auto mb-4" />
            <p className="text-slate-500 font-medium">Por favor, configure um orçamento primeiro.</p>
          </div>
        );
      }

      const getMonths = (start, end) => {
        const months = [];
        let current = new Date(start);
        const last = new Date(end);
        while (current <= last) {
          months.push(new Date(current));
          current.setMonth(current.getMonth() + 1);
        }
        return months;
      };

      const months = getMonths(currentBudget.startDate, currentBudget.endDate).reverse();
      const rfPerc = currentBudget.reserveFundPercentage ?? 10;
      const monthlyTotal = currentBudget.totalAmount / 12;

      const togglePaid = async (userId, monthKey) => {
        if (!isAdmin) return;
        const quotaId = `${userId}_${monthKey}`;
        const existing = quotas.find(q => q.firestoreId === quotaId);

        if (existing) {
          alert('Uma quota já paga não pode ser revertida, pois o recibo já foi enviado por e-mail.');
          return;
        }

        const user = users.find(u => u.firestoreId === userId);
        const [year, monthIdx] = monthKey.split('-').map(Number);
        const monthName = t(`months.${monthIdx}`);

        if (!confirm(`Tem a certeza que deseja marcar a quota de ${monthName} ${year} (${user.fraction}) como paga? Esta ação é irreversível e enviará um e-mail de recibo.`)) {
          return;
        }

        try {
          await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'quotas', quotaId), {
            userId,
            monthKey,
            status: 'paid',
            updatedAt: new Date().toISOString()
          });

          // Enviar e-mail de recibo
          if (user && user.email) {
            const perm = parseFloat(user.permilagem) || 0;
            const quotaBase = (monthlyTotal * (perm / 1000));
            const reserveFund = quotaBase * (rfPerc / 100);
            const total = quotaBase + reserveFund;
            const dateObj = new Date();
            const today = dateObj.toLocaleDateString('pt-PT');
            const condoName = condo?.name || 'Condomínio';

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mail'), {
              to: user.email,
              message: {
                subject: `Recibo de Pagamento - Quota ${monthName} ${year} - ${user.fraction}`,
                html: `
                  <p>O Condomínio ${condoName} comprova que a quota referente ao mês ${monthName} foi paga no dia ${today} para a fração ${user.fraction}.</p>
                  <p>O presente email serve como recibo de pagamento.</p>
                  <hr>
                  <p><strong>Detalhes do Pagamento:</strong></p>
                  <ul>
                    <li><strong>Fração:</strong> ${user.fraction}</li>
                    <li><strong>Mês de Referência:</strong> ${monthName} ${year}</li>
                    <li><strong>Valor Pago:</strong> ${total.toFixed(2)} €</li>
                    <li><strong>Data de Pagamento:</strong> ${today}</li>
                  </ul>
                `
              }
            });
          }
        } catch (err) {
          alert('Erro ao atualizar estado de pagamento: ' + err.message);
        }
      };

      return (
        <div className="space-y-6">
          <div className="pt-2">
            <h2 className="text-[26px] font-bold text-slate-800">Conta Corrente</h2>
            <p className="text-slate-500 text-sm mt-1">Controlo de quotas pagas por condómino</p>
          </div>

          <div className="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden overflow-x-auto">
            <table className="w-full text-left text-sm border-collapse">
              <thead>
                <tr className="bg-slate-50 text-slate-500 border-b border-slate-100">
                  <th className="px-4 py-4 font-semibold sticky left-0 bg-slate-50 min-w-[150px] z-10">Fração / Mês</th>
                  {months.map((m, idx) => (
                    <th key={idx} className="px-4 py-4 font-semibold text-center min-w-[120px]">
                      {m.toLocaleDateString('pt-PT', { month: 'short', year: '2-digit' })}
                    </th>
                  ))}
                </tr>
              </thead>
              <tbody className="divide-y divide-slate-50">
                {users.map(user => {
                  const perm = parseFloat(user.permilagem) || 0;
                  const quotaBase = (monthlyTotal * (perm / 1000));
                  const reserveFund = quotaBase * (rfPerc / 100);
                  const total = quotaBase + reserveFund;

                  return (
                    <tr key={user.firestoreId} className="hover:bg-slate-50/50 transition-colors">
                      <td className="px-4 py-4 sticky left-0 bg-white group-hover:bg-slate-50 z-10 border-r border-slate-50">
                        <p className="font-bold text-slate-900">{user.fraction}</p>
                        <p className="text-[11px] text-slate-400 truncate w-32">{user.name}</p>
                      </td>
                      {months.map((m, idx) => {
                        const monthKey = `${m.getFullYear()}-${m.getMonth()}`;
                        const isPaid = quotas.some(q => q.userId === user.firestoreId && q.monthKey === monthKey);
                        return (
                          <td key={idx} className="px-4 py-4 text-center">
                            <button 
                              onClick={() => togglePaid(user.firestoreId, monthKey)}
                              disabled={!isAdmin || isPaid}
                              className={`w-full p-2 rounded-xl transition-all border ${isPaid ? 'bg-green-50 border-green-100 text-green-700 cursor-not-allowed opacity-100' : 'bg-white border-slate-100 text-slate-400 hover:border-blue-200'}`}
                            >
                              {isPaid ? (
                                <div className="flex flex-col items-center">
                                  <CheckCircle className="w-4 h-4 mb-0.5" />
                                  <span className="text-[10px] font-bold uppercase tracking-tight">Pago</span>
                                </div>
                              ) : (
                                <div className="flex flex-col items-center opacity-60 group-hover:opacity-100">
                                  <div className="text-[10px] font-medium leading-tight">
                                    <div>Q: {quotaBase.toFixed(2)}€</div>
                                    <div>FR: {reserveFund.toFixed(2)}€</div>
                                    <div className="border-t border-slate-200 mt-1 pt-0.5 font-bold text-slate-600">Σ {total.toFixed(2)}€</div>
                                  </div>
                                </div>
                              )}
                            </button>
                          </td>
                        );
                      })}
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
          <div className="flex items-center gap-2 text-xs text-slate-400 px-2">
            <div className="w-3 h-3 bg-green-50 border border-green-100 rounded"></div>
            <span>Pago</span>
            <div className="w-3 h-3 bg-white border border-slate-100 rounded ml-4"></div>
            <span>Pendente (Q: Quota, FR: Fundo Reserva, Σ: Total)</span>
          </div>
        </div>
      );
    }

    function SettingsPage({ currentUser, db, appId, t }) {
      const [name, setName] = useState(currentUser.name);
      const [language, setLanguage] = useState(currentUser.language || 'pt');
      const [saving, setSaving] = useState(false);
      const [message, setMessage] = useState({ type: '', text: '' });

      const handleSave = async (e) => {
        e.preventDefault();
        setSaving(true); setMessage({ type: '', text: '' });
        try {
          await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', currentUser.firestoreId), { 
            name,
            language 
          });
          setMessage({ type: 'success', text: t('profileSaved') });
        } catch (err) {
          setMessage({ type: 'error', text: t('errorSaving') });
        } finally {
          setSaving(false);
        }
      };

      return (
        <div className="space-y-6 max-w-2xl">
          <div className="pt-2"><h2 className="text-[26px] font-bold text-slate-800">{t('settings')}</h2></div>
          <form onSubmit={handleSave} className="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm space-y-6">
            {message.text && <div className={`p-4 rounded-xl text-sm font-medium ${message.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>{message.text}</div>}
            <div>
              <label className="block text-sm font-semibold mb-2 ml-1 text-slate-700">{t('nameLabel')}</label>
              <input required type="text" className="w-full px-5 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500" value={name} onChange={e => setName(e.target.value)} />
            </div>
            <div>
              <label className="block text-sm font-semibold mb-2 ml-1 text-slate-700">{t('languageLabel')}</label>
              <select 
                className="w-full px-5 py-3.5 border border-slate-200 bg-slate-50 focus:bg-white rounded-xl outline-none focus:ring-2 focus:ring-blue-500 appearance-none"
                value={language}
                onChange={e => setLanguage(e.target.value)}
              >
                <option value="pt">Português</option>
                <option value="en">English</option>
                <option value="fr">Français</option>
              </select>
            </div>
            <button type="submit" disabled={saving} className="w-full bg-blue-600 active:bg-blue-700 text-white px-6 py-4 rounded-xl font-semibold disabled:opacity-50">
              {saving ? t('saving') : t('save')}
            </button>
          </form>
        </div>
      );
    }

    // --- INICIALIZAÇÃO DO REACT ---
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
